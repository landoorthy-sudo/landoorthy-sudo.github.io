<div class="stc-wrapper">
    <div class="stc-header">
        <div class="stc-title-box">
            <h3 class="stc-main-title">Save the Cat! Board</h3>
            <span class="stc-tips">Happy writing!</span>
        </div>
        <div class="stc-actions">
            <button id="stc-gen-report" class="stc-btn-primary">生成报告</button>
            <button id="stc-clear-all" class="stc-btn-danger">清空</button>
        </div>
    </div>

    <div class="stc-progress-container">
        <div class="stc-progress-text">进度：<span id="stc-prog-val">0</span> / 40</div>
        <div class="stc-progress-bar-bg"><div id="stc-progress-fill" class="stc-progress-fill"></div></div>
    </div>

    <div id="stc-board-scroll">
        <div id="stc-board-container"></div>
    </div>
</div>

<div id="stc-modal" class="stc-modal">
    <div class="stc-modal-content">
        <h4>大纲报告</h4>
        <textarea id="stc-report-area" readonly></textarea>
        <div style="text-align:right; margin-top:10px;">
            <button class="stc-btn-primary" onclick="document.getElementById('stc-modal').style.display='none'">关闭</button>
        </div>
    </div>
</div>

<style>
    .stc-wrapper { 
        background: #f4f4f9 !important; padding: 15px !important; border-radius: 12px !important; 
        margin: 20px auto !important; max-width: 1100px !important; color: #333 !important; 
        box-shadow: 0 8px 24px rgba(0,0,0,0.08); 
    }
    .stc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .stc-main-title { margin: 0 !important; font-size: 1rem !important; font-weight: bold !important; border:none !important;}
    .stc-tips { font-size: 11px; color: #999; }
    .stc-actions { display: flex; gap: 5px; }

    .stc-progress-container { margin-bottom: 15px; background: #fff; padding: 6px 10px; border-radius: 6px; }
    .stc-progress-text { font-size: 10px; margin-bottom: 3px; color: #888; font-weight: bold; }
    .stc-progress-bar-bg { width: 100%; height: 5px; background: #eee; border-radius: 3px; overflow: hidden; }
    .stc-progress-fill { width: 0%; height: 100%; background: #957DAD; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

    #stc-board-scroll { overflow-x: auto; padding-bottom: 15px; cursor: default; }
    #stc-board-container { display: flex; flex-direction: column; gap: 6px; min-width: 2600px !important; }

    .stc-row { display: flex; gap: 6px; height: 130px !important; }
    .stc-row-label { 
        writing-mode: vertical-lr; text-align: center; font-weight: bold; color: #bbb; 
        width: 22px; background: #fff; border-radius: 4px; font-size: 9px;
        display: flex; justify-content: center; align-items: center; flex-shrink: 0;
    }

    .stc-slot {
        width: 110px !important; height: 125px !important; background: #e8e8ed !important;
        border-radius: 4px !important; position: relative !important; flex-shrink: 0 !important;
        border: 1px dashed transparent;
    }

    .stc-beat-hint {
        position: absolute; width: 100%; top: 50%; transform: translateY(-50%);
        text-align: center; color: rgba(0,0,0,0.12); font-size: 10px; font-weight: bold; pointer-events: none;
    }

    .stc-card {
        width: 110px !important; height: 125px !important; border-radius: 4px !important;
        position: absolute !important; top: 0; left: 0; cursor: grab;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important; overflow: hidden !important; z-index: 5;
    }
    .stc-card:active { cursor: grabbing; }
    
    .stc-card-tools { height: 18px; padding: 2px 4px 0; display: flex; justify-content: space-between; align-items: center; }
    .stc-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(0,0,0,0.12); cursor: pointer; }
    .stc-del { font-size: 12px; cursor: pointer; color: #666; opacity: 0.5; font-family: sans-serif; }
    .stc-del:hover { opacity: 1; color: #ff4d4f; }
    
    .stc-inp-title {
        display: block !important; width: 100px !important; height: 16px !important;
        margin: 0 5px 2px 5px !important; font-weight: bold !important; font-size: 11px !important;
        border: none !important; background: transparent !important; outline: none !important; padding: 0 !important;
    }
    .stc-area-body {
        display: block !important; width: 100px !important; height: 58px !important;
        margin: 0 5px !important; font-size: 10px !important; line-height: 1.3 !important;
        border: none !important; background: transparent !important; outline: none !important;
        resize: none !important; overflow-y: auto !important; padding: 0 !important;
    }
    .stc-card-footer {
        height: 20px !important; margin-top: 2px !important; border-top: 1px solid rgba(0,0,0,0.05) !important;
        display: flex !important; padding: 0 4px !important;
    }
    .stc-f-item { flex: 1; display: flex; align-items: center; font-size: 8px; color: #777; }
    .stc-f-item input { width: 100% !important; border: none !important; background: transparent !important; font-size: 8px !important; outline: none !important; padding: 0 2px !important;}

    .stc-btn-primary { background: #957DAD; color: white; border: none; padding: 3px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }
    .stc-btn-danger { background: #f0f0f5; color: #999; border: none; padding: 3px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }
    .stc-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; }
    .stc-modal-content { background:#fff; width:90%; max-width:500px; margin: 40px auto; padding:15px; border-radius:8px; }
    #stc-report-area { width:100%; height:300px; font-size: 11px; padding:10px; border:1px solid #eee; margin-top:10px; line-height: 1.6; }
    .stc-add-btn { font-size: 18px; color: #fff; cursor: pointer; opacity: 0.5; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: absolute; top:0; left:0; }
</style>

<script>
(function() {
    const COLORS = ['#FFDFD3', '#E0BBE4', '#957DAD', '#D291BC', '#FEC8D8', '#B5EAD7'];
    const ROW_NAMES = ["第一幕", "第二幕(上)", "第二幕(下)", "第三幕"];
    const BEATS = {
        "0-0": "开场画面", "0-5": "铺垫完成", "0-9": "打破常规", "1-0": "进入第二幕",
        "1-7": "B故事开始", "2-0": "中点", "2-7": "坏人逼近", "2-12": "失去一切",
        "2-14": "灵魂黑夜", "3-0": "进入第三幕", "3-7": "终极对决", "3-14": "结尾画面"
    };

    function init() {
        const container = document.getElementById('stc-board-container');
        if (!container) return;
        container.innerHTML = '';

        for (let r = 0; r < 4; r++) {
            const row = document.createElement('div');
            row.className = 'stc-row';
            row.innerHTML = `<div class="stc-row-label">${ROW_NAMES[r]}</div>`;
            for (let c = 0; c < 22; c++) {
                const slot = document.createElement('div');
                slot.className = 'stc-slot';
                slot.id = `stc-s-${r}-${c}`;
                slot.dataset.row = r; slot.dataset.col = c;
                
                resetSlot(slot);

                slot.ondragover = (e) => { e.preventDefault(); slot.style.border = "1px dashed #957DAD"; };
                slot.ondragleave = () => { slot.style.border = "1px dashed transparent"; };
                slot.ondrop = handleDrop;
                
                row.appendChild(slot);
            }
            container.appendChild(row);
        }
        load();
        setupGlobalEvents();
        updateProgress();
    }

    function resetSlot(slot) {
        const beatKey = `${slot.dataset.row}-${slot.dataset.col}`;
        const hintText = BEATS[beatKey] || "";
        slot.innerHTML = `
            ${hintText ? `<div class="stc-beat-hint">${hintText}</div>` : ''}
            <div class="stc-add-btn">+</div>
        `;
        slot.onclick = (e) => {
            if (e.target.classList.contains('stc-add-btn') || e.target === slot) createCard(slot);
        };
    }

    function createCard(slot, data = null) {
        const d = data || { id: 'c'+Date.now()+Math.floor(Math.random()*100), t: '', b: '', pm: '', cf: '', ci: 0 };
        const card = document.createElement('div');
        card.className = 'stc-card';
        card.id = d.id;
        card.draggable = true;
        card.style.backgroundColor = COLORS[d.ci];
        card.dataset.ci = d.ci;

        card.innerHTML = `
            <div class="stc-card-tools"><div class="stc-dot"></div><div class="stc-del">×</div></div>
            <input class="stc-inp-title" placeholder="标题" value="${d.t}" spellcheck="false">
            <textarea class="stc-area-body" placeholder="情节描述..." spellcheck="false">${d.b}</textarea>
            <div class="stc-card-footer">
                <div class="stc-f-item">+/- <input value="${d.pm}"></div>
                <div class="stc-f-item" style="border-left:1px solid rgba(0,0,0,0.05);padding-left:3px">! <input value="${d.cf}"></div>
            </div>`;

        card.querySelector('.stc-del').onclick = (e) => {
            e.stopPropagation();
            if(confirm('删除卡片？')) {
                const parentSlot = card.parentElement;
                card.remove();
                resetSlot(parentSlot);
                save();
                updateProgress();
            }
        };

        card.querySelector('.stc-dot').onclick = (e) => {
            e.stopPropagation();
            card.dataset.ci = (parseInt(card.dataset.ci) + 1) % COLORS.length;
            card.style.backgroundColor = COLORS[card.dataset.ci]; 
            save(); 
        };

        card.ondragstart = (e) => {
            e.dataTransfer.setData("text/plain", card.id);
            setTimeout(() => card.style.display = "none", 0);
        };
        card.ondragend = () => card.style.display = "block";
        card.oninput = save;
        
        slot.innerHTML = '';
        slot.appendChild(card);
        if(!data) { save(); updateProgress(); }
    }

    function handleDrop(e) {
        e.preventDefault();
        this.style.border = "1px dashed transparent";
        const id = e.dataTransfer.getData("text/plain");
        const card = document.getElementById(id);
        if(!card) return;

        const oldSlot = card.parentElement;
        const targetSlot = this;
        const targetExistCard = targetSlot.querySelector('.stc-card');

        if(targetExistCard) {
            oldSlot.appendChild(targetExistCard);
            targetSlot.appendChild(card);
        } else {
            targetSlot.appendChild(card);
            resetSlot(oldSlot);
        }
        save();
    }

    function updateProgress() {
        const count = document.querySelectorAll('.stc-card').length;
        document.getElementById('stc-prog-val').innerText = count;
        document.getElementById('stc-progress-fill').style.width = Math.min((count / 40 * 100), 100) + '%';
    }

    function setupGlobalEvents() {
        document.getElementById('stc-gen-report').onclick = () => {
            let report = "【STC 故事大纲报告】\n\n";
            document.querySelectorAll('.stc-row').forEach((row, i) => {
                const cards = row.querySelectorAll('.stc-card');
                if(cards.length > 0) {
                    report += `\n--- ${ROW_NAMES[i]} ---\n`;
                    cards.forEach((card, idx) => {
                        const t = card.querySelector('.stc-inp-title').value || "未命名";
                        const b = card.querySelector('.stc-area-body').value || "无内容";
                        report += `${idx+1}. ${t}\n   ${b}\n`;
                    });
                }
            });
            document.getElementById('stc-report-area').value = report;
            document.getElementById('stc-modal').style.display = 'block';
        };
        document.getElementById('stc-clear-all').onclick = () => { 
            if(confirm('清空所有内容？')) { localStorage.removeItem('stc_v3_data'); init(); } 
        };
    }

    function save() {
        const res = [];
        document.querySelectorAll('.stc-card').forEach(c => {
            const s = c.parentElement;
            res.push({ r: s.dataset.row, c: s.dataset.col, id: c.id, t: c.querySelector('.stc-inp-title').value, b: c.querySelector('.stc-area-body').value, pm: c.querySelectorAll('input')[1].value, cf: c.querySelectorAll('input')[2].value, ci: c.dataset.ci });
        });
        localStorage.setItem('stc_v3_data', JSON.stringify(res));
    }

    function load() {
        const raw = localStorage.getItem('stc_v3_data');
        if(raw) { 
            JSON.parse(raw).forEach(d => { 
                const s = document.getElementById(`stc-s-${d.r}-${d.c}`); 
                if(s) createCard(s, d); 
            }); 
        }
    }

    window.addEventListener('load', init);
})();
</script>
